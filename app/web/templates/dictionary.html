{% extends "base.html" %}
{% block content %}
  <h1>Dictionary</h1>

  {% if dicts|length == 0 %}
    <div class="card">
      <p><strong>No dictionaries installed.</strong></p>
      <p class="hint">Ask an admin to upload an MDX ZIP in Admin: Dictionaries.</p>
    </div>
  {% else %}
    <section class="card">
      <form method="post" action="/dictionary/search" class="row searchbar">
        <div class="grow">
          <input class="biginput" name="query" placeholder="Search a word..." value="{{ query }}" autofocus />
        </div>
        <div>
          <select name="dict_id">
            {% for d in dicts %}
              <option value="{{ d.id }}" {% if d.id == selected_dict_id %}selected{% endif %}>{{ d.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div><button type="submit">Search</button></div>
      </form>
      <p class="hint">Tip: searches are case-sensitive in many MDX dictionaries.</p>
    </section>

    {% if result %}
      <section class="card">
        <div class="row space-between">
          <h2>Matches for: {{ query }}</h2>

          
  {% if query %}
  {% if favourite %}
    <div class="row" style="align-items:center; gap:10px; width: 100%;">
      <!-- Mastery controls (immediate updates) -->
      <form method="post" action="/dictionary/mastery_dec" class="inline">
        <input type="hidden" name="dict_id" value="{{ selected_dict_id }}" />
        <input type="hidden" name="headword" value="{{ query }}" />
        <input type="hidden" name="fav_id" value="{{ favourite.id }}" />
        <button type="submit" class="button">-</button>
      </form>

      <div class="hint" style="min-width:110px; text-align:center;">
        Mastery: <strong>{{ favourite.mastery }}</strong> / 5
      </div>

      <form method="post" action="/dictionary/mastery_inc" class="inline">
        <input type="hidden" name="dict_id" value="{{ selected_dict_id }}" />
        <input type="hidden" name="headword" value="{{ query }}" />
        <input type="hidden" name="fav_id" value="{{ favourite.id }}" />
        <button type="submit" class="button">+</button>
      </form>

      <!-- Notes + Save -->
      <form method="post" action="/dictionary/favourite" class="row" style="flex:1; gap:8px;">
        <input type="hidden" name="dict_id" value="{{ selected_dict_id }}" />
        <input type="hidden" name="headword" value="{{ query }}" />
        <!-- mastery included for consistency; keeps existing mastery if user doesn't change it -->
        <input type="hidden" name="mastery" value="{{ favourite.mastery }}" />
        <input name="notes" placeholder="Notes..." class="notesinput" value="{{ favourite.notes }}" style="flex:1;" />
        <button type="submit">Save</button>
      </form>

      <!-- Toggle favourite (asks for confirmation) -->
      <form method="post" action="/dictionary/unfavourite" class="inline"
            onsubmit="return confirm('Unfavourite this word?');">
        <input type="hidden" name="dict_id" value="{{ selected_dict_id }}" />
        <input type="hidden" name="headword" value="{{ query }}" />
        <input type="hidden" name="fav_id" value="{{ favourite.id }}" />
        <button type="submit">★</button>
      </form>
    </div>
  {% else %}
    <div class="row" style="align-items:center; gap:10px; width: 100%;">
      <!-- Mastery controls (client-side only until saved) -->
      <button type="button" class="button" onclick="decMastery()">-</button>
      <div class="hint" style="min-width:110px; text-align:center;">
        Mastery: <strong id="mval">1</strong> / 5
      </div>
      <button type="button" class="button" onclick="incMastery()">+</button>

      <form method="post" action="/dictionary/favourite" class="row" style="flex:1; gap:8px;">
        <input type="hidden" name="dict_id" value="{{ selected_dict_id }}" />
        <input type="hidden" name="headword" value="{{ query }}" />
        <input type="hidden" name="mastery" id="mastery" value="1" />
        <input name="notes" placeholder="Optional notes..." class="notesinput" style="flex:1;" />
        <button type="submit">☆ Favourite</button>
      </form>
    </div>

    <script>
      (function() {
        let m = 1;
        const mval = document.getElementById("mval");
        const hidden = document.getElementById("mastery");
        window.incMastery = function() {
          m = Math.min(5, m + 1);
          mval.textContent = String(m);
          hidden.value = String(m);
        }
        window.decMastery = function() {
          m = Math.max(1, m - 1);
          mval.textContent = String(m);
          hidden.value = String(m);
        }
      })();
    </script>
  {% endif %}
{% endif %}
</div>

        {% if not result.found %}
          <p><em>Not found.</em></p>
        {% else %}
                    <div class="hint">Showing {{ result.entries|length }} matching record(s).</div>

{% if favourite %}
  <div class="card" style="margin-top: 10px;">
    <form method="post" action="/dictionary/favourite">
      <input type="hidden" name="dict_id" value="{{ selected_dict_id }}" />
      <input type="hidden" name="headword" value="{{ query }}" />
      <input type="hidden" name="mastery" value="{{ favourite.mastery }}" />
      <textarea name="notes" rows="10" maxlength="2000" placeholder="Notes...">{{ favourite.notes }}</textarea>
      <div class="row">
        <button type="submit">Save notes</button>
      </div>
    </form>
  </div>
{% endif %}

          {% for e in result.entries %}
            <article class="card">
              <h3>{{ e.headword }}</h3>

              <div class="definition">
                <div id="def-{{ loop.index0 }}"></div>
              </div>

              <script>
                (function() {
                  const host = document.getElementById("def-{{ loop.index0 }}");
                  if (!host) return;

                  // Shadow DOM isolates dictionary CSS so it won't affect the whole page.
                  const root = host.attachShadow({ mode: "open" });
                  const html = {{ e.html | tojson }};
                  const cssUrl = {{ dict_css_url | tojson }};

                  const baseStyle = document.createElement('style');
                  baseStyle.textContent = `
                    :host { display: block; }
                    img { max-width: 100%; height: auto; }
                    * { user-select: text !important; -webkit-user-select: text !important; }
                  `;
                  root.appendChild(baseStyle);

                  if (cssUrl) {
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = cssUrl;
                    root.appendChild(link);
                  }

                  const wrap = document.createElement('div');
                  wrap.innerHTML = html;
                  root.appendChild(wrap);
                })();
              </script>
            </article>
          {% endfor %}
        {% endif %}
      </section>
    {% endif %}
  {% endif %}
{% endblock %}
