{% extends "base.html" %}
{% block content %}
  <h1>History</h1>

  {% if dicts|length == 0 %}
    <div class="card">
      <p><strong>No dictionaries installed.</strong></p>
      <p class="hint">Ask an admin to upload an MDX ZIP in Admin: Dictionaries.</p>
    </div>
  {% else %}
    <div class="row space-between">
      <form method="get" action="/history" class="row">
        <label class="row">Dictionary:
          <select name="dict_id" onchange="this.form.submit()">
            {% for d in dicts %}
              <option value="{{ d.id }}" {% if d.id == selected_dict_id %}selected{% endif %}>{{ d.name }}</option>
            {% endfor %}
          </select>
        </label>
      </form>
      <form method="post" action="/history/clear" onsubmit="return confirm('Clear ALL history?');">
        <button class="danger" type="submit">Clear all</button>
      </form>
    </div>

    <div class="split">
      <aside class="panel">
        <h2>Recent searches</h2>
        {% if items|length == 0 %}
          <p class="hint">No history yet. Search something in Dictionary.</p>
        {% else %}
          <div class="list-scroll">
            <ul class="list">
              {% for it in items %}
                <li class="{% if selected_item and selected_item.id == it.id %}active{% endif %} clickable"
                    onclick="window.location.href='/history?dict_id={{ selected_dict_id }}&item_id={{ it.id }}';">
                  <a href="/history?dict_id={{ selected_dict_id }}&item_id={{ it.id }}">{{ it.headword }}</a>

                  <form method="post" action="/history/{{ it.id }}/delete" class="inline" onclick="event.stopPropagation();">
                    <input type="hidden" name="dict_id" value="{{ selected_dict_id }}" />
                    <button class="linklike-dark" type="submit">âœ•</button>
                  </form>

                  <div class="hint small">{{ it.created_at }}</div>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </aside>

      <section class="panel">
        {% if selected_item %}
          <h2>{{ selected_item.headword }}</h2>

          <div class="card">
            <h3>Definition</h3>
            {% if result and result.found %}
              <div class="hint">Showing {{ result.entries|length }} matching record(s) from the selected dictionary.</div>

              {% for e in result.entries %}
                <article class="card">
                  <h4>{{ e.headword }}</h4>

                  <div class="definition">
                    <div id="def-{{ loop.index0 }}"></div>
                  </div>

                  <script>
                    (function() {
                      const host = document.getElementById("def-{{ loop.index0 }}");
                      if (!host) return;

                      const root = host.attachShadow({ mode: "open" });
                      const html = {{ e.html | tojson }};
                      const cssUrl = {{ dict_css_url | tojson }};

                      const baseStyle = document.createElement('style');
                      baseStyle.textContent = `
                        :host { display: block; }
                        img { max-width: 100%; height: auto; }
                        * { user-select: text !important; -webkit-user-select: text !important; }
                      `;
                      root.appendChild(baseStyle);

                      if (cssUrl) {
                        const link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.href = cssUrl;
                        root.appendChild(link);
                      }

                      const wrap = document.createElement('div');
                      wrap.innerHTML = html;
                      root.appendChild(wrap);
                    })();
                  </script>
                </article>
              {% endfor %}
            {% else %}
              <p class="hint">No definition available in the selected dictionary.</p>
            {% endif %}
          </div>
        {% else %}
          <p class="hint">Select an item on the left.</p>
        {% endif %}
      </section>
    </div>
  {% endif %}
{% endblock %}
