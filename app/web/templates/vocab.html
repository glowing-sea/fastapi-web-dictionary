{% extends "base.html" %}
{% block content %}
  <h1>Vocabulary (Favourites)</h1>

  {% if dicts|length == 0 %}
    <div class="card">
      <p><strong>No dictionaries installed.</strong></p>
      <p class="hint">Ask an admin to upload an MDX ZIP in Admin: Dictionaries.</p>
    </div>
  {% else %}

    <div class="row space-between">
      <form method="get" action="/vocab" class="row">
        <label class="row">Dictionary:
          <select name="dict_id" onchange="this.form.submit()">
            {% for d in dicts %}
              <option value="{{ d.id }}" {% if d.id == selected_dict_id %}selected{% endif %}>{{ d.name }}</option>
            {% endfor %}
          </select>
        </label>

        <label class="row">Sort by:
          <select name="sort_by">
            <option value="alpha" {% if sort_by=="alpha" %}selected{% endif %}>Alphabet</option>
            <option value="date" {% if sort_by=="date" %}selected{% endif %}>Created date</option>
            <option value="mastery" {% if sort_by=="mastery" %}selected{% endif %}>Mastery</option>
          </select>
        </label>

        <label class="row">Order:
          <select name="order">
            <option value="asc" {% if order=="asc" %}selected{% endif %}>Ascending</option>
            <option value="desc" {% if order=="desc" %}selected{% endif %}>Descending</option>
          </select>
        </label>

        <button type="submit">Apply</button>
      </form>

      <div class="row">
        <a class="button" href="/vocab/export?dict_id={{ selected_dict_id }}">Export JSON</a>
        <form method="post" action="/vocab/clear" onsubmit="return confirm('Delete ALL vocabulary?');">
          <input type="hidden" name="dict_id" value="{{ selected_dict_id }}" />
          <button class="danger" type="submit">Delete all</button>
        </form>
      </div>
    </div>

    <section class="card">
      <h2>Import JSON</h2>
      <p class="hint">
        JSON format: <code>[{"word":"apple","notes":"...","mastery":3,"created_at":"..."}, ...]</code>.
        Existing words will have their notes/mastery/date overwritten.
      </p>
      <form method="post" action="/vocab/import" enctype="multipart/form-data" class="row">
        <input type="hidden" name="dict_id" value="{{ selected_dict_id }}" />
        <input type="file" name="json_file" accept="application/json,.json" required />
        <button type="submit">Import</button>
      </form>
    </section>

    <div class="split">
      <aside class="panel">
        <h2>Words</h2>
        {% if favourites|length == 0 %}
          <p class="hint">No favourites yet. Search a word and click â˜† Favourite.</p>
        {% else %}
          <div class="list-scroll">
            <ul class="list">
              {% for f in favourites %}
                <li class="{% if selected_fav and selected_fav.id == f.id %}active{% endif %} clickable"
                    onclick="window.location.href='/vocab?dict_id={{ selected_dict_id }}&fav_id={{ f.id }}&sort_by={{ sort_by }}&order={{ order }}';">
                  <a href="/vocab?dict_id={{ selected_dict_id }}&fav_id={{ f.id }}&sort_by={{ sort_by }}&order={{ order }}">{{ f.headword }}</a>
                  <div class="hint small">{{ f.created_at }}</div>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </aside>

      <section class="panel">
        <div class="rhs-scroll">
        {% if selected_fav %}
          <div class="row space-between" style="align-items: center;">
            <div>
              <h2 style="margin:0;">{{ selected_fav.headword }}</h2>
              <div class="hint small">{{ selected_fav.created_at }}</div>
            </div>

            <div class="row" style="gap:10px; align-items:center;">
              <form method="post" action="/vocab/{{ selected_fav.id }}/mastery_dec" class="inline" onclick="event.stopPropagation();">
                <input type="hidden" name="dict_id" value="{{ selected_dict_id }}" />
                <input type="hidden" name="sort_by" value="{{ sort_by }}" />
                <input type="hidden" name="order" value="{{ order }}" />
                <button type="submit" class="button">-</button>
              </form>

              <div class="hint" style="min-width:110px; text-align:center;">
                Mastery: <strong>{{ selected_fav.mastery }}</strong> / 5
              </div>

              <form method="post" action="/vocab/{{ selected_fav.id }}/mastery_inc" class="inline" onclick="event.stopPropagation();">
                <input type="hidden" name="dict_id" value="{{ selected_dict_id }}" />
                <input type="hidden" name="sort_by" value="{{ sort_by }}" />
                <input type="hidden" name="order" value="{{ order }}" />
                <button type="submit" class="button">+</button>
              </form>

              <form method="post" action="/vocab/{{ selected_fav.id }}/delete" onclick="event.stopPropagation();">
                <input type="hidden" name="dict_id" value="{{ selected_dict_id }}" />
                <button class="danger" type="submit">Remove</button>
              </form>
            </div>
          </div>

          <!-- Notes editor (no "Notes" header / no separate panel title) -->
          <div class="card">
            <form method="post" action="/vocab/{{ selected_fav.id }}/notes">
              <input type="hidden" name="dict_id" value="{{ selected_dict_id }}" />
              <textarea name="notes" rows="6" maxlength="2000" placeholder="Notes...">{{ selected_fav.notes }}</textarea>
              <div class="row">
                <button type="submit">Save notes</button>
              </div>
            </form>
          </div>

          <div class="card">
            <h3>Definition</h3>
            {% if result and result.found %}
              <div class="hint">Showing {{ result.entries|length }} matching record(s) from the selected dictionary.</div>

              {% for e in result.entries %}
                <article class="card">
                  <h4>{{ e.headword }}</h4>

                  <div class="definition">
                    <div id="def-{{ loop.index0 }}"></div>
                  </div>

                  <script>
                    (function() {
                      const host = document.getElementById("def-{{ loop.index0 }}");
                      if (!host) return;

                      const root = host.attachShadow({ mode: "open" });
                      const html = {{ e.html | tojson }};
                      const cssUrl = {{ dict_css_url | tojson }};

                      const baseStyle = document.createElement('style');
                      baseStyle.textContent = `
                        :host { display: block; }
                        img { max-width: 100%; height: auto; }
                        * { user-select: text !important; -webkit-user-select: text !important; }
                      `;
                      root.appendChild(baseStyle);

                      if (cssUrl) {
                        const link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.href = cssUrl;
                        root.appendChild(link);
                      }

                      const wrap = document.createElement('div');
                      wrap.innerHTML = html;
                      root.appendChild(wrap);
                    })();
                  </script>
                </article>
              {% endfor %}
            {% else %}
              <p class="hint">No definition available in the selected dictionary.</p>
            {% endif %}
          </div>
        {% else %}
          <p class="hint">Select a word on the left.</p>
        {% endif %}
        </div>
      </section>
    </div>
  {% endif %}
{% endblock %}
